---
title: "FINAL_DATA"
output: html_document
date: "2025-04-24"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r}
library(tidyverse)
library(haven)
library(dplyr)
library(lubridate)
library(lme4)
library(car)
library(ggplot2)
library(pwr)
library(pscl)
library(mgcv)
library(vcd)
library(ggcorrplot)
library(mice)
library(VIM)
library(logistf)
library(MASS)
library(gridExtra)
library(corrplot)
library(reshape2)
library(cowplot)
library(caret)
library(class)
library(DMwR2)
library(GGally)
library(boot)
library(purrr)
library(effects)
library(pROC)
```


Fitrering og merging af vores data
```{r}
startdato <- as.Date("2010-02-01", origin = "1970-01-01")

masterdata_15 <- masterdata[masterdata$FirstDiagnosisDate >= startdato, ]

final_master_15 <- subset(masterdata_15, select = c(PatientID,BirthDate,Sex,InitialMSPhenotype,FirstDiagnosisDate, OnsetDate, Relapse24mth))

final_master_15 <- subset(final_master_15, InitialMSPhenotype == "RR")

final_master_15 <- final_master_15 %>%
  mutate(YearAtFirstDiagnosis = year(FirstDiagnosisDate))

final_master_15$YearAtFirstDiagnosis <- factor(final_master_15$YearAtFirstDiagnosis)  

final_master_15 <- final_master_15 %>%
  mutate(AgeAtFirstDiagnosis = round(as.numeric((FirstDiagnosisDate - BirthDate)/365.24), 2)) 

final_master_15$AgeGroup <- cut(final_master_15$AgeAtFirstDiagnosis,
                                breaks = c(-Inf, 17, 29, 39, 49, 59, 69, Inf), 
                                labels = c("<18", "18-29", "30-39", "40-49", "50-59", "60-69", "70+"),
                                right = FALSE)

final_master_15$AgeGroup <- droplevels(final_master_15$AgeGroup)


 treatment$TreatmentDrugCategorized <- ifelse(treatment$TreatmentDrug %in% c( 2,3,6,22,21,4,5,24,11,7,16), 0, 1)
 
 tabel_filtreret <- subset(treatment, TreatmentDrug > 0 & TreatmentDrug < 34 & TreatmentDrug !=11 & TreatmentDrug !=7 & TreatmentDrug !=7 & TreatmentDrug !=9 & TreatmentDrug !=10 & TreatmentDrug !=10 & TreatmentDrug !=20 & TreatmentDrug !=16 & TreatmentDrug !=15 & TreatmentDrug !=17 & TreatmentDrug !=30 & TreatmentDrug !=19 & TreatmentDrug !=25 & TreatmentDrug !=27  )
 
 final_treatment <- subset(tabel_filtreret, select = -c(TreatmentDrug, Generic, SerieNumber, SerieStartDate, SerieEndDate,CauseTerminationTreatment, CauseNoTreatment, AdminStartDate, Administration))
 
 final_edss <- subset(edss, select = c(PatientID,EDSS,EDSSDate))
 
 final_mri <- subset(mri, select = c(PatientID,BrainT2))
 
 master_treatment_joined <- final_master_15 %>% 
  inner_join(final_treatment, by = "PatientID")
 
 master_edss_joined <- final_master_15 %>% 
  inner_join(final_edss, by = "PatientID", relationship = "many-to-many") 
 
 master_mri_joined <- final_master_15 %>% 
  inner_join(final_mri, by = "PatientID", relationship = "many-to-many")
 
 master_treatment_edss_joined <- master_treatment_joined %>% 
  inner_join(final_edss, by = "PatientID", relationship = "many-to-many")
 
 master_all_joined <- master_treatment_edss_joined %>% 
  inner_join(final_mri, by = "PatientID", relationship = "many-to-many")

```


Unik patientID
```{r}
all_filtered <- master_all_joined %>%
  group_by(PatientID) %>%
  mutate(TimeDiff = abs(difftime(EDSSDate, FirstDiagnosisDate, units = "days"))) %>%
  filter(TimeDiff == min(TimeDiff)) %>%
  ungroup() %>%
  distinct(PatientID, .keep_all = TRUE)  

all_filtered <- subset (all_filtered, select = -c (TimeDiff))
```


Ændring i datatype og variabel levels
```{r}
all_filtered <- as.data.frame(all_filtered)

str(all_filtered[, c("Sex", "Relapse24mth", "AgeGroup", "EDSS", "BrainT2", "YearAtFirstDiagnosis")])

all_filtered$Sex <- as.factor(all_filtered$Sex)
all_filtered$EDSS <- as.factor(all_filtered$EDSS)
all_filtered$BrainT2 <- as.factor(all_filtered$BrainT2)
all_filtered$AgeGroup <- as.factor(all_filtered$AgeGroup)


levels(all_filtered$BrainT2) <- c("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10-20", ">20", "Unknown")

levels(all_filtered$Sex)
all_filtered$Sex <- relevel(all_filtered$Sex, ref = "2")

levels(all_filtered$EDSS)
all_filtered$EDSS <- relevel(all_filtered$EDSS, ref = "0")

levels(all_filtered$BrainT2)
all_filtered$BrainT2 <- relevel(all_filtered$BrainT2, ref = "0")

levels(all_filtered$AgeGroup)
all_filtered$AgeGroup <- relevel(all_filtered$AgeGroup, ref = "18-29")
```


Fjernelse af året 2025 i variablen 'YearAtFirstDiagnosis'
```{r}
all_filtered <- all_filtered %>%
  filter(YearAtFirstDiagnosis != 2025)
```


Outliers
```{r fig.width=10, fig.height=5, echo=FALSE, message=FALSE, warning=FALSE}
independent_vars <- c("Relapse24mth", "AgeGroup", "EDSS", "BrainT2", "YearAtFirstDiagnosis", "Sex")


boxplot(all_filtered[, independent_vars],
        ylab = "Values", 
        col = "lightblue", 
        las = 2, 
        cex.axis = 0.8,  
        cex.names = 0.7,
        par(mar = c(10, 5, 4, 2)),
        na.rm = TRUE
)

outliers_to_remove <- c(1092021, 1042022)

all_filtered <- all_filtered[!all_filtered$Relapse24mth %in% outliers_to_remove, ]
```


Missing data type
```{r}
colSums(is.na(all_filtered[, c("Sex", "Relapse24mth", "AgeGroup", "EDSS", "BrainT2", "YearAtFirstDiagnosis")]))

filtered_na_data <- all_filtered[is.na(all_filtered$BrainT2) | is.na(all_filtered$Relapse24mth),  ]

filtered_na_data$BrainT2_missing <- is.na(filtered_na_data$BrainT2)

ggplot(filtered_na_data, aes(x = factor(BrainT2_missing), y = AgeGroup, fill = factor(BrainT2_missing))) +
  geom_boxplot() +
  labs(title = "Fordeling af AgeGroup efter BrainT2 Missing", x = "BrainT2 Missing", y = "AgeGroup") +
  scale_fill_manual(values = c("red", "blue"), labels = c("Værdier uden N/A", "Kun N/A værdier")) +
  theme_minimal()

ggplot(filtered_na_data, aes(x = Sex, fill = factor(BrainT2_missing))) +
  geom_bar(position = "dodge") +
  labs(title = "Fordeling af Sex efter BrainT2 Missing", x = "Sex", fill = "BrainT2 Missing") +
  scale_fill_manual(values = c("red", "blue"), labels = c("Værdier uden N/A", "Kun N/A værdier")) +
  theme_minimal()

ggplot(filtered_na_data, aes(x = YearAtFirstDiagnosis, fill = factor(BrainT2_missing))) +
  geom_bar(position = "dodge") +
  labs(title = "Fordeling af YearAtFirstDiagnosis efter BrainT2 Missing", 
       x = "YearAtFirstDiagnosis", 
       fill = "BrainT2 Missing") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1)) + 
  scale_fill_manual(values = c("red", "blue"), labels = c("Værdier uden N/A", "Kun N/A værdier")) +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 8))  

ggplot(filtered_na_data, aes(x = factor(EDSS), fill = factor(BrainT2_missing))) +
  geom_bar(position = "dodge") +
  labs(title = "Fordeling af EDSS efter BrainT2 Missing", 
       x = "EDSS", 
       fill = "BrainT2 Missing") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1)) +  
  scale_fill_manual(values = c("red", "blue"), labels = c("Værdier uden N/A", "Kun N/A værdier")) +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 8))  

filtered_na_data$Relapse24mth_missing <- is.na(filtered_na_data$Relapse24mth)

ggplot(filtered_na_data, aes(x = factor(Relapse24mth_missing), y = AgeGroup, fill = factor(Relapse24mth_missing))) +
  geom_boxplot() +
  labs(title = "Fordeling af AgeGroup efter Relapse24mth Missing", x = "Relapse24mth Missing", y = "AgeGroup") +
  scale_fill_manual(values = c("red", "blue"), labels = c("Værdier uden N/A", "Kun N/A værdier")) +
  theme_minimal()

ggplot(filtered_na_data, aes(x = Sex, fill = factor(Relapse24mth_missing))) +
  geom_bar(position = "dodge") +
  labs(title = "Fordeling af Sex efter Relapse24mth Missing", x = "Sex", fill = "Relapse24mth Missing") +
  scale_fill_manual(values = c("red", "blue"), labels = c("Værdier uden N/A", "Kun N/A værdier")) +
  theme_minimal()

ggplot(filtered_na_data, aes(x = YearAtFirstDiagnosis, fill = factor(Relapse24mth_missing))) +
  geom_bar(position = "dodge") +
  labs(title = "Fordeling af YearAtFirstDiagnosis efter Relapse24mth Missing", 
       x = "YearAtFirstDiagnosis", 
       fill = "Relapse24mth Missing") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1)) +  
  scale_fill_manual(values = c("red", "blue"), labels = c("Værdier uden N/A", "Kun N/A værdier")) +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 8))  

ggplot(filtered_na_data, aes(x = factor(EDSS), fill = factor(Relapse24mth_missing))) +
  geom_bar(position = "dodge") +
  labs(title = "Fordeling af EDSS efter Relapse24mth Missing", 
       x = "EDSS", 
       fill = "Relapse24mth Missing") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1)) +  
  scale_fill_manual(values = c("red", "blue"), labels = c("Værdier uden N/A", "Kun N/A værdier")) +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 8))  

```


Hvilken k?
```{r}
all_filtered_copy <- all_filtered

k_values <- seq(1, 20, by = 2)

all_filtered_copy <- na.omit(all_filtered_copy)
categorical_vars <- c("Sex", "YearAtFirstDiagnosis", "EDSS", "BrainT2", "AgeGroup")
numeric_vars <- c("Relapse24mth")
all_filtered_copy[categorical_vars] <- lapply(all_filtered_copy[categorical_vars], as.factor)
all_filtered_copy[numeric_vars] <- scale(all_filtered_copy[numeric_vars])

predictors <- all_filtered_copy[, c(categorical_vars, numeric_vars)]
outcome <- as.factor(all_filtered_copy$TreatmentDrugCategorized)

predictors <- model.matrix(~ . - 1, data = predictors)

train_data <- data.frame(predictors, TreatmentDrugCategorized = outcome)

train_control <- trainControl(method = "cv", number = 5)  

knn_model <- train(TreatmentDrugCategorized ~ ., data = train_data, method = "knn", 
                   tuneGrid = expand.grid(k = k_values), trControl = train_control)

print(knn_model)
```


K-nærmeste nabo + fjernelse af N/A
```{r}
all_filtered_imputed <- VIM::kNN(all_filtered, variable = c("BrainT2", "Relapse24mth"), k = 13)


all_filtered_imputed <- subset (all_filtered_imputed, select = -c (BrainT2_imp))
all_filtered_imputed <- subset (all_filtered_imputed, select = -c (Relapse24mth_imp))

colSums(is.na(all_filtered_imputed[, c("Sex", "Relapse24mth", "AgeGroup", "EDSS", "BrainT2", "YearAtFirstDiagnosis")]))

```


Sammenligning af Relapse24mth før og efter imputering.
```{r}
df_before <- data.frame(BrainT2 = all_filtered$BrainT2, Type = "Before imputation")
df_after  <- data.frame(BrainT2 = all_filtered_imputed$BrainT2, Type = "After imputation")
df_combined_brain <- rbind(df_before, df_after)

ggplot(df_combined_brain, aes(x = BrainT2, fill = Type)) +
  geom_bar(position = "dodge") +
  theme_minimal() +
  ggtitle("Sammenligning af BrainT2 før og efter imputering")

df_before_relapse <- data.frame(Relapse24mth = all_filtered$Relapse24mth, Type = "Before imputation")
df_after_relapse  <- data.frame(Relapse24mth = all_filtered_imputed$Relapse24mth, Type = "After imputation")
df_combined_relapse <- rbind(df_before_relapse, df_after_relapse)

df_combined_relapse$Relapse24mth <- factor(df_combined_relapse$Relapse24mth, levels = c(0:12, NA))

ggplot(df_combined_relapse, aes(x = Relapse24mth, fill = Type)) +
  geom_bar(position = "dodge") +
  theme_minimal() +
  ggtitle("Sammenligning af Relapse24mth før og efter imputering") +
  labs(x = "Relapse24mth", y = "Antal observationer") +
  scale_x_discrete(breaks = c(0:12, NA)) 


```


Uafh variables fordelinger
```{r}
generate_plot <- function(data, variable, plot_type, title, x_lab, y_lab, fill_color, bins = NULL, breaks = NULL) {
  if (plot_type == "histogram") {
    ggplot(data, aes(x = .data[[variable]])) +
      geom_histogram(fill = fill_color, bins = bins, color = "black") +
      scale_x_continuous(breaks = breaks) + 
      labs(title = title, x = x_lab, y = y_lab) +
      theme_minimal()
  } else if (plot_type == "bar") {
    ggplot(data, aes(x = .data[[variable]])) +
      geom_bar(stat = "count", fill = fill_color, color = "black") +  
      labs(title = title, x = x_lab, y = y_lab) +
      theme_minimal() +
      scale_x_discrete(limits = breaks) + 
      theme(axis.text.x = element_text(angle = 45, hjust = 1))
  } else if (plot_type == "pie") {
    ggplot(data, aes(x = "", fill = .data[[variable]])) +
      geom_bar(stat = "count", width = 1, color = "black") +  
      coord_polar(theta = "y") + 
      labs(title = title) +
      scale_fill_manual(values = c("1" = "green", "2" = "pink")) +  
      theme_minimal() +
      theme(axis.text.x = element_blank(),  
            axis.ticks = element_blank(),    
            panel.grid = element_blank(),   
            plot.title = element_text(hjust = 0.5, size = 14),  
            axis.title.x = element_blank(),  
            axis.title.y = element_blank(),  
            plot.margin = margin(0, 0, 0, 0))
  }
}

p1 <- generate_plot(all_filtered_imputed, "AgeGroup", "bar", 
                    "Distribution of age at first diagnosis", "AgeGroup", "Count", "lightblue", bins = 30)
p2 <- generate_plot(all_filtered_imputed, "EDSS", "bar", "Distribution of EDSS Scores", "EDSS", "Count", "lightcoral")
p3 <- generate_plot(all_filtered_imputed, "Relapse24mth", "histogram", 
                    "Distribution of Relapse24mth", "Relapse Count", "Count", "lightgreen", bins = 15, breaks = 0:12)
p4 <- generate_plot(all_filtered_imputed, "BrainT2", "bar", "Distribution of BrainT2 categories", 
                    "BrainT2 Category", "Count", "purple", breaks = c("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10-20", ">20", "unknown"))
p5 <- generate_plot(all_filtered_imputed, "Sex", "pie", "Distribution of Sex", NULL, NULL, NULL)
p6 <- generate_plot(all_filtered_imputed, "YearAtFirstDiagnosis", "bar", "Distribution of year at first diagnosis", "YearOfFirstDiagnosis", "Count", "orange")

grid.arrange(p1, p2, p3, p4, p5, p6, ncol = 2)
```


Klassefordeling
```{r}

table(all_filtered_imputed$TreatmentDrugCategorized)
prop.table(table(all_filtered_imputed$TreatmentDrugCategorized)) * 100 

ggplot(all_filtered_imputed, aes(x = as.factor(TreatmentDrugCategorized), fill = as.factor(TreatmentDrugCategorized))) +
  geom_bar() +
  scale_x_discrete(labels = c("0" = "Moderat effektiv behandling", "1" = "Høj effektiv behandling")) +  
  scale_fill_manual(values = c("0" = "red", "1" = "blue"),
                    labels = c("0" = "Moderat effektiv behandling", "1" = "Høj effektiv behandling")) +
  labs(title = "Klassefordeling af TreatmentDrugCategorized",
       x = "",
       y = "Antal",
       fill = "Behandlingstype") +
  theme_minimal()

treatment_trends <- all_filtered_imputed %>%
  filter(TreatmentDrugCategorized %in% c(0, 1)) %>%
  group_by(YearAtFirstDiagnosis, TreatmentDrugCategorized) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(Percentage = n / sum(n) * 100)  

ggplot(treatment_trends, aes(x = YearAtFirstDiagnosis, y = Percentage, color = as.factor(TreatmentDrugCategorized))) +
  geom_line(size = 1) + 
  geom_point(size = 2) +
  labs(title = "Udvikling i første behandling over tid",
       x = "Årstal for første diagnose",
       y = "Andel af patienter (%)",
       color = "Behandlingstype") +
  scale_color_manual(values = c("0" = "red", "1" = "blue"), labels = c("Moderat Effekt", "Høj Effekt")) +
  theme_minimal()


vars_to_plot <- c("Relapse24mth", "EDSS", "YearAtFirstDiagnosis", "Sex", "BrainT2", "AgeGroup")

create_plot <- function(var_name, data) {
  count_data <- data %>%
    filter(TreatmentDrugCategorized %in% c(0, 1)) %>%
    count(TreatmentDrugCategorized, !!sym(var_name))
  
  ggplot(count_data, aes_string(x = var_name, y = "n", color = "as.factor(TreatmentDrugCategorized)", size = "n")) +
    geom_point(alpha = 0.7) + 
    labs(title = paste("Antal patienter per", var_name, "(Moderat 0 vs Høj 1)"),
         x = var_name,
         y = "Antal patienter",
         color = "TreatmentDrug") +
    scale_color_manual(values = c("0" = "red", "1" = "blue")) +  
    scale_size(range = c(2, 10)) + 
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
}

for (var in vars_to_plot) {
  print(create_plot(var, all_filtered))
}


```


Korrelationsplot
```{r}
vars_all <- all_filtered_imputed[, c("Relapse24mth", "AgeGroup", "EDSS", "Sex", "BrainT2", "YearAtFirstDiagnosis")]

vars_all <- data.frame(lapply(vars_all, as.numeric))

str(vars_all)

cor_matrix <- cor(vars_all, use = "complete.obs", method = "spearman")

cor_long <- melt(cor_matrix)

cor_long <- cor_long[as.numeric(cor_long$Var1) <= as.numeric(cor_long$Var2), ]

ggplot(cor_long, aes(Var1, Var2, fill = value)) +
  geom_tile(color = "white") +  
  geom_text(aes(label = round(value, 2)), color = "black", size = 4) +  
  scale_fill_gradient2(low = "cyan", mid = "white", high = "orange", 
                       midpoint = 0, limits = c(-1, 1), breaks = seq(-1, 1, by = 0.5)) +  
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +  
  labs(title = "Heatmap of Correlations", fill = "Correlation")


```


Udvælgelse via stepwise regression af model med interaktioner
```{r}

# Definér prædiktorer
predictors <- c("Sex", "Relapse24mth", "AgeGroup", "EDSS", "BrainT2", "YearAtFirstDiagnosis")

# Lav alle to-vejs interaktioner
interaction_terms <- combn(predictors, 2, FUN = function(x) paste0(x[1], ":", x[2]))
all_terms <- c(predictors, interaction_terms)

# Byg formel til full model med ALLE hoved- og interaktionseffekter
full_formula <- as.formula(paste("TreatmentDrugCategorized ~", paste(all_terms, collapse = " + ")))

# Byg minimal model (kun intercept)
minimal_model <- glm(TreatmentDrugCategorized ~ 1,
                     data = all_filtered_imputed,
                     family = binomial)

# Byg full model
full_model <- glm(full_formula,
                  data = all_filtered_imputed,
                  family = binomial)

# Stepwise regression (forward + backward selection ud fra AIC)
stepwise_model <- stepAIC(minimal_model,
                          scope = list(lower = formula(minimal_model), upper = formula(full_model)),
                          direction = "both",
                          trace = TRUE)

# Output
summary(stepwise_model)S
```


Sammenligning af baseline model med modellen med interaktioner
```{r}

baseline_model <- glm(TreatmentDrugCategorized ~ Sex + Relapse24mth +  AgeGroup + EDSS + BrainT2 + YearAtFirstDiagnosis,
                      data = all_filtered_imputed,
                      family = binomial)

model_with_interactions <- glm(TreatmentDrugCategorized ~ 
                           Sex + Relapse24mth + AgeGroup + EDSS + BrainT2 + YearAtFirstDiagnosis +
                           YearAtFirstDiagnosis * Relapse24mth + Relapse24mth * Sex,
                         data = all_filtered_imputed,
                         family = binomial)

anova(model_with_interactions, baseline_model, test = "LRT")
```


Assumptions
```{r}

#ASSUMPTION 1
is.numeric(all_filtered_imputed$TreatmentDrugCategorized) && all(all_filtered_imputed$TreatmentDrugCategorized%in% c(0,1))

#ASSUMPTION 2 (uafhængighed)

#ASSUMPTION 3
vif_model <- glm(TreatmentDrugCategorized ~ 
                                    Sex + Relapse24mth + YearAtFirstDiagnosis + EDSS + BrainT2 + AgeGroup + 
                                    Relapse24mth * YearAtFirstDiagnosis + Sex * Relapse24mth,
                                  data = all_filtered_imputed,
                                  family = binomial)

vif(vif_model)



#ASSUMPTION 4
scaled_data <- all_filtered_imputed
scaled_data$Relapse24mth <- scale(scaled_data$Relapse24mth)


gam_model <- gam(TreatmentDrugCategorized ~ 
                                    Sex + s(Relapse24mth) + YearAtFirstDiagnosis + EDSS + BrainT2 + AgeGroup + 
                                    Relapse24mth * YearAtFirstDiagnosis + Sex * Relapse24mth,
                                  data = all_filtered_imputed,
                                  family = binomial)
  
summary(gam_model)
plot(gam_model)




#ASSUMPTION 5
n_var <- length(coef(final_model_1)) - 1 

outcome_freq <- table(all_filtered_imputed$TreatmentDrugCategorized)

p_least_frequent <- min(outcome_freq) / sum(outcome_freq)

minimum_sample_size <- 10 * n_var / p_least_frequent

actual_sample_size <- nrow(all_filtered_imputed)

if (actual_sample_size >= minimum_sample_size) {
  print("Prøvestørrelsen er tilstrækkelig")
} else {
  print("Prøvestørrelsen er ikke tilstrækkelig")
}

```


Finder den optiamle cut-off 
```{r}

opt_cutoff <- coords(roc_curve, x = "best", best.method = "youden", transpose = FALSE)
print(opt_cutoff)


predicted_class_opt <- ifelse(predictions > opt_cutoff$threshold, 1, 0)


confusion_matrix_opt <- confusionMatrix(factor(predicted_class_opt), factor(all_filtered_imputed$TreatmentDrugCategorized))
print(confusion_matrix_opt)


precision_opt <- confusion_matrix_opt$byClass['Pos Pred Value']
recall_opt <- confusion_matrix_opt$byClass['Sensitivity']
f1_score_opt <- 2 * (precision_opt * recall_opt) / (precision_opt + recall_opt)

print(paste("Ny cut-off: ", round(opt_cutoff$threshold, 3)))
print(paste("Precision (opt): ", precision_opt))
print(paste("Recall (opt): ", recall_opt))
print(paste("F1-score (opt): ", f1_score_opt))

```


Misklassifikations test (confusion matrix + roc curve)
```{r}
all_filtered_imputed$YearAtFirstDiagnosis <- as.factor(all_filtered_imputed$YearAtFirstDiagnosis)

predictions <- predict(final_model_1, type = "response", newdata = all_filtered_imputed)

predicted_class <- ifelse(predictions > 0.245, 1, 0)



confusion_matrix <- confusionMatrix(factor(predicted_class), factor(all_filtered_imputed$TreatmentDrugCategorized), positive = "1")
print(confusion_matrix)

confusion_df <- as.data.frame(confusion_matrix$table)
ggplot(confusion_df, aes(x = Prediction, y = Reference)) +
  geom_tile(aes(fill = Freq), color = "white") +
  scale_fill_gradient(low = "white", high = "purple") +
  geom_text(aes(label = Freq), vjust = 1) +
  theme_minimal() +
  labs(title = "Confusion Matrix Heatmap")



precision <- confusion_matrix$byClass['Pos Pred Value']
recall <- confusion_matrix$byClass['Sensitivity']
f1_score <- 2 * (precision * recall) / (precision + recall)

print(paste("Precision: ", precision))
print(paste("Recall: ", recall))
print(paste("F1-score: ", f1_score))



par(pty="s")

roc_curve <- roc(all_filtered_imputed$TreatmentDrugCategorized, predictions,
                 levels = c("0", "1"), direction = "<")


plot(roc_curve, main = "ROC Curve", col = "black", xlim = c(0, 1), ylim = c(0, 1))


auc_value <- auc(roc_curve)
text(0.5, 0.2, paste("AUC: ", round(auc_value, 2)), col = "blue", cex = 1.5)
points(0, 1, col = "red", pch = 19, cex = 1.5)
text(0, 1, "Perfekt Klassifikator", col = "red", pos = 4, cex = 1)
print(paste("AUC: ", auc_value))
```


Models pasform test
```{r}
mcfadden_r2 <- 1 - (final_model_1$deviance / final_model_1$null.deviance)

print(paste("McFadden's R-squared: ", mcfadden_r2))
```


Variablernes unikke effekt
```{r}
vars <- c("Sex", "Relapse24mth", "AgeGroup", "EDSS", "BrainT2", "YearAtFirstDiagnosis", "Relapse24mth*Sex", "Relapse24mth*YearAtFirstDiagnosis")

full_formula <- as.formula(paste("TreatmentDrugCategorized ~", paste(vars, collapse = " + ")))
model_full <- glm(full_formula, family = binomial, data = all_filtered_imputed)
aic_full <- AIC(model_full)

aic_diffs <- sapply(vars, function(var) {
  reduced_vars <- setdiff(vars, var)
  formula_reduced <- as.formula(paste("TreatmentDrugCategorized ~", paste(reduced_vars, collapse = " + ")))
  model_reduced <- glm(formula_reduced, family = binomial, data = all_filtered_imputed)
  AIC(model_reduced) - aic_full
})

aic_table <- data.frame(
  Variable = vars,
  AIC_Increase = round(aic_diffs, 2)
)

aic_table <- aic_table[order(-aic_table$AIC_Increase), ]

print(aic_table)
```


Log Odds ratio
```{r, fig.width=10, fig.height=7}


log_odds_ratios <- coef(final_model_1)

data <- data.frame(Variable = names(log_odds_ratios), LogOddsRatio = log_odds_ratios)


data <- data %>% filter(Variable != "(Intercept)")


get_main_category <- function(var) {
  if (str_detect(var, "EDSS")) return("EDSS")
  if (str_detect(var, "BrainT2")) return("BrainT2")
  if (str_detect(var, "AgeGroup")) return("AgeGroup")
  if (str_detect(var, "YearAtFirstDiagnosis")) return("YearAtFirstDiagnosis")
  if (str_detect(var, "Sex")) return("Sex")
  if (str_detect(var, "Relapse24mth")) return("Relapse24mth")
  return("Other")
}

data$Category <- ifelse(str_detect(data$Variable, ":"), 
                        sapply(str_split(data$Variable, ":"), function(parts) {
                          cats <- sapply(parts, get_main_category)
                          paste(sort(cats), collapse = "_")
                        }),
                        sapply(data$Variable, get_main_category))


all_levels <- list(
  AgeGroup = c("AgeGroup18-29", "AgeGroup30-39", "AgeGroup40-49", "AgeGroup50-59", "AgeGroup60-69", "AgeGroup70+"),
  EDSS = c("EDSS1", "EDSS1.5", "EDSS2", "EDSS2.5", "EDSS3", "EDSS3.5", "EDSS4", "EDSS4.5", "EDSS5", "EDSS5.5", "EDSS6", "EDSS6.5", "EDSS7", "EDSS7.5", "EDSS8"),
  Sex = c("Sex0", "Sex1"),  # eksempel, hvor Sex0 er reference
  YearAtFirstDiagnosis = paste0("YearAtFirstDiagnosis", 2011:2024),
  BrainT2 = c("BrainT21", "BrainT22", "BrainT23", "BrainT24", "BrainT25", "BrainT26", "BrainT27", "BrainT28", "BrainT29", "BrainT210-20", "BrainT2Unknown"),
  Relapse24mth = c("Relapse24mth0", "Relapse24mth1")
)


existing_vars <- data$Variable


ref_rows <- lapply(names(all_levels), function(cat) {
  levels <- all_levels[[cat]]
  
  ref_levels <- setdiff(levels, existing_vars)
  
 
  if(length(ref_levels) > 0){
    data.frame(Variable = ref_levels,
               LogOddsRatio = 0,
               Category = cat,
               stringsAsFactors = FALSE)
  } else {
    NULL
  }
})

all_colors <- c(
  "AgeGroup" = "orange",
  "EDSS" = "lightblue",
  "Sex" = "purple",
  "YearAtFirstDiagnosis" = "pink",
  "BrainT2" = "green",
  "Relapse24mth" = "yellow",
  "Relapse24mth_Sex" = "cyan",
  "Relapse24mth_YearAtFirstDiagnosis" = "red"
 
)

ref_data <- do.call(rbind, ref_rows)


full_data <- bind_rows(data, ref_data) %>% arrange(Category, desc(LogOddsRatio))


ggplot(full_data, aes(x = reorder(Variable, LogOddsRatio), y = LogOddsRatio, fill = Category)) +
  geom_bar(stat = "identity") +
  labs(x = "Variable", y = "Log Odds-Ratio", title = "Log Odds-Ratio for Variable i Logistisk Model inkl. referencekategori") +
  theme_minimal() +
  scale_fill_manual(values = all_colors) + 
  coord_flip() +  
  theme(axis.text.y = element_text(size = 6.5))
```


Finder de præcise log-odds koefficienter
```{r}

log_odds_ratios <- coef(final_model_1)


data <- data.frame(
  Variable = names(log_odds_ratios),
  LogOddsRatio = as.numeric(log_odds_ratios),
  stringsAsFactors = FALSE
) %>%
  filter(Variable != "(Intercept)")


get_main_category <- function(var) {
  if (str_detect(var, "EDSS")) return("EDSS")
  if (str_detect(var, "BrainT2")) return("BrainT2")
  if (str_detect(var, "AgeGroup")) return("AgeGroup")
  if (str_detect(var, "YearAtFirstDiagnosis")) return("YearAtFirstDiagnosis")
  if (str_detect(var, "Sex")) return("Sex")
  if (str_detect(var, "Relapse24mth")) return("Relapse24mth")
  return("Other")
}


data$Category <- ifelse(str_detect(data$Variable, ":"), 
                        sapply(str_split(data$Variable, ":"), function(parts) {
                          cats <- sapply(parts, get_main_category)
                          paste(sort(cats), collapse = "_")
                        }),
                        sapply(data$Variable, get_main_category))


all_levels <- list(
  AgeGroup = c("AgeGroup18-29", "AgeGroup30-39", "AgeGroup40-49", "AgeGroup50-59", "AgeGroup60-69", "AgeGroup70+"),
  EDSS = c("EDSS1", "EDSS1.5", "EDSS2", "EDSS2.5", "EDSS3", "EDSS3.5", "EDSS4", "EDSS4.5", "EDSS5", "EDSS5.5", "EDSS6", "EDSS6.5", "EDSS7", "EDSS7.5", "EDSS8"),
  Sex = c("Sex0", "Sex1"),
  YearAtFirstDiagnosis = paste0("YearAtFirstDiagnosis", 2011:2024),
  BrainT2 = c("BrainT21", "BrainT22", "BrainT23", "BrainT24", "BrainT25", "BrainT26", "BrainT27", "BrainT28", "BrainT29", "BrainT210-20", "BrainT2Unknown"),
  Relapse24mth = c("Relapse24mth0", "Relapse24mth1")
)

existing_vars <- data$Variable


ref_rows <- lapply(names(all_levels), function(cat) {
  levels <- all_levels[[cat]]
  ref_levels <- setdiff(levels, existing_vars)
  if(length(ref_levels) > 0){
    data.frame(Variable = ref_levels,
               LogOddsRatio = 0,
               Category = cat,
               stringsAsFactors = FALSE)
  } else {
    NULL
  }
})
ref_data <- do.call(rbind, ref_rows)


full_data <- bind_rows(data, ref_data) %>%
  arrange(desc(LogOddsRatio))

full_data$OddsRatio <- round(exp(full_data$LogOddsRatio), 3)


log_odds_table <- full_data[, c("Variable", "LogOddsRatio", "Category", "OddsRatio")]
print(log_odds_table)

```


Konfidensintervaller:
```{r}
confint.default(final_model_1) 
```


P-værdier korrigerede for multiple hypothesis testing
```{r}

model_summary <- summary(final_model_1)


p_values <- coef(model_summary)[, "Pr(>|z|)"]

adjusted_p <- p.adjust(p_values, method = "bonferroni")  

p_table <- data.frame(
  Variable = names(p_values),
  Raw_p = p_values,
  Adjusted_p = adjusted_p
)


p_table <- p_table[order(p_table$Adjusted_p), ]

print(p_table)

```


p-værdier fordelt på år:
```{r fig.width=10, fig.height=5, echo=FALSE, message=FALSE, warning=FALSE}
years <- sort(unique(all_filtered_imputed$YearAtFirstDiagnosis))

# --------------------- EDSS ---------------------
data_list_edss <- lapply(years, function(year) {
  subset(all_filtered_imputed, YearAtFirstDiagnosis == year)
})

logistic_models_edss <- lapply(data_list_edss, function(data) {
  if (nrow(data) > 1) {
    tryCatch(
      glm(TreatmentDrugCategorized ~ Sex + Relapse24mth + AgeGroup + EDSS + BrainT2,
          data = data,
          family = binomial),
      error = function(e) return(NULL)
    )
  } else {
    return(NULL)
  }
})

results_edss <- data.frame(
  Year = rep(years, each = length(levels(all_filtered_imputed$EDSS))),
  EDSS_value = rep(levels(all_filtered_imputed$EDSS), times = length(years)),
  Estimate = NA,
  p_value = NA
)

for (i in 1:length(logistic_models_edss)) {
  model <- logistic_models_edss[[i]]
  if (!is.null(model)) {
    model_summary <- summary(model)
    edss_levels <- levels(all_filtered_imputed$EDSS)
    
    for (j in 1:length(edss_levels)) {
      edss_index <- grep(paste("EDSS", edss_levels[j], sep = ""), rownames(model_summary$coefficients))
      if (length(edss_index) > 0) {
        results_edss$Estimate[(i - 1) * length(edss_levels) + j] <- model_summary$coefficients[edss_index, 1]
        results_edss$p_value[(i - 1) * length(edss_levels) + j] <- model_summary$coefficients[edss_index, 4]
      }
    }
  }
}

# Bonferroni-korrektion
num_tests_edss <- sum(!is.na(results_edss$p_value))
results_edss$p_value_corrected <- pmin(results_edss$p_value * num_tests_edss, 1)

results_edss$Significance <- cut(results_edss$p_value_corrected, 
                                 breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
                                 labels = c("p<0.001", "p<0.01", "p<0.05", "p>0.05 (ikke signifikant)"))

ggplot(results_edss, aes(x = as.factor(Year), y = as.factor(EDSS_value), fill = Significance)) +
  geom_tile(color = "white") +
  scale_fill_manual(values = c("p>0.05 (ikke signifikant)" = "lightgray", 
                               "p<0.05" = "lightblue", 
                               "p<0.01" = "steelblue", 
                               "p<0.001" = "darkblue")) +
  labs(title = "Signifikans af EDSS-niveauer over tid (Bonferroni-korrigeret)",
       x = "År", y = "EDSS-niveau", fill = "Signifikans") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "top")


# --------------------- BrainT2 ---------------------
data_list_brainT2 <- lapply(years, function(year) {
  subset(all_filtered_imputed, YearAtFirstDiagnosis == year)
})

logistic_models_brainT2 <- lapply(data_list_brainT2, function(data) {
  if (nrow(data) > 1) {
    tryCatch(
      glm(TreatmentDrugCategorized ~ Sex + Relapse24mth + AgeGroup + EDSS + BrainT2,
          data = data,
          family = binomial),
      error = function(e) return(NULL)
    )
  } else {
    return(NULL)
  }
})

results_brainT2 <- data.frame(
  Year = rep(years, each = length(levels(all_filtered_imputed$BrainT2))),
  BrainT2_value = rep(levels(all_filtered_imputed$BrainT2), times = length(years)),
  Estimate = NA,
  p_value = NA
)

for (i in 1:length(logistic_models_brainT2)) {
  model <- logistic_models_brainT2[[i]]
  if (!is.null(model)) {
    model_summary <- summary(model)
    brainT2_levels <- levels(all_filtered_imputed$BrainT2)
    
    for (j in 1:length(brainT2_levels)) {
      brainT2_index <- grep(paste("BrainT2", brainT2_levels[j], sep = ""), rownames(model_summary$coefficients))
      if (length(brainT2_index) > 0) {
        results_brainT2$Estimate[(i - 1) * length(brainT2_levels) + j] <- model_summary$coefficients[brainT2_index, 1]
        results_brainT2$p_value[(i - 1) * length(brainT2_levels) + j] <- model_summary$coefficients[brainT2_index, 4]
      }
    }
  }
}

num_tests_brainT2 <- sum(!is.na(results_brainT2$p_value))
results_brainT2$p_value_corrected <- pmin(results_brainT2$p_value * num_tests_brainT2, 1)

results_brainT2$Significance <- cut(results_brainT2$p_value_corrected, 
                                    breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
                                    labels = c("p<0.001", "p<0.01", "p<0.05", "p>0.05 (ikke signifikant)"))

ggplot(results_brainT2, aes(x = as.factor(Year), y = BrainT2_value, fill = Significance)) +
  geom_tile(color = "white") +
  scale_fill_manual(values = c("p>0.05 (ikke signifikant)" = "lightgray", 
                               "p<0.05" = "lightblue", 
                               "p<0.01" = "steelblue", 
                               "p<0.001" = "darkblue")) +
  labs(title = "Signifikans af BrainT2-niveauer over tid (Bonferroni-korrigeret)",
       x = "År", y = "BrainT2-niveau", fill = "Signifikans") +
  scale_y_discrete(limits = levels(all_filtered_imputed$BrainT2)) +  
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "top")


# --------------------- AgeGroup ---------------------
data_list_agegroup <- lapply(years, function(year) {
  subset(all_filtered_imputed, YearAtFirstDiagnosis == year)
})

logistic_models_agegroup <- lapply(data_list_agegroup, function(data) {
  if (nrow(data) > 1) {
    tryCatch(
      glm(TreatmentDrugCategorized ~ Sex + Relapse24mth + EDSS + BrainT2 + AgeGroup,
          data = data,
          family = binomial),
      error = function(e) return(NULL)
    )
  } else {
    return(NULL)
  }
})

results_agegroup <- data.frame(
  Year = rep(years, each = length(levels(all_filtered_imputed$AgeGroup))),
  AgeGroup_value = rep(levels(all_filtered_imputed$AgeGroup), times = length(years)),
  Estimate = NA,
  p_value = NA
)

for (i in 1:length(logistic_models_agegroup)) {
  model <- logistic_models_agegroup[[i]]
  if (!is.null(model)) {
    model_summary <- summary(model)
    agegroup_levels <- levels(all_filtered_imputed$AgeGroup)
    
    for (j in 1:length(agegroup_levels)) {
      agegroup_index <- grep(paste("AgeGroup", agegroup_levels[j], sep = ""), rownames(model_summary$coefficients))
      if (length(agegroup_index) > 0) {
        results_agegroup$Estimate[(i - 1) * length(agegroup_levels) + j] <- model_summary$coefficients[agegroup_index, 1]
        results_agegroup$p_value[(i - 1) * length(agegroup_levels) + j] <- model_summary$coefficients[agegroup_index, 4]
      }
    }
  }
}

num_tests_agegroup <- sum(!is.na(results_agegroup$p_value))
results_agegroup$p_value_corrected <- pmin(results_agegroup$p_value * num_tests_agegroup, 1)

results_agegroup$Significance <- cut(results_agegroup$p_value_corrected, 
                                     breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
                                     labels = c("p<0.001", "p<0.01", "p<0.05", "p>0.05 (ikke signifikant)"))

ggplot(results_agegroup, aes(x = as.factor(Year), y = AgeGroup_value, fill = Significance)) +
  geom_tile(color = "white") +
  scale_fill_manual(values = c("p>0.05 (ikke signifikant)" = "lightgray", 
                               "p<0.05" = "lightblue", 
                               "p<0.01" = "steelblue", 
                               "p<0.001" = "darkblue")) +
  labs(title = "Signifikans af AgeGroup over tid (Bonferroni-korrigeret)",
       x = "År", y = "Aldersgruppe", fill = "Signifikans") +
  scale_y_discrete(limits = levels(all_filtered_imputed$AgeGroup)) +  
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "top")


# --------------------- Sex & Relapse24mth ---------------------
data_list_sex_relapse <- lapply(years, function(year) {
  subset(all_filtered_imputed, YearAtFirstDiagnosis == year)
})

logistic_models_sex_relapse <- lapply(data_list_sex_relapse, function(data) {
  if (nrow(data) > 1) {
    tryCatch(
      glm(TreatmentDrugCategorized ~ Sex + Relapse24mth + EDSS + BrainT2 + AgeGroup,
          data = data,
          family = binomial),
      error = function(e) return(NULL)
    )
  } else {
    return(NULL)
  }
})

results_sex_relapse <- data.frame(
  Year = rep(years, each = 2), 
  Variable = rep(c("Sex", "Relapse24mth"), times = length(years)),
  Estimate = NA,
  p_value = NA
)

for (i in 1:length(logistic_models_sex_relapse)) {
  model <- logistic_models_sex_relapse[[i]]
  if (!is.null(model)) {
    model_summary <- summary(model)
    variables <- c("Sex", "Relapse24mth")  
    
    for (j in 1:length(variables)) {
      var_index <- grep(variables[j], rownames(model_summary$coefficients))
      if (length(var_index) > 0) {
        results_sex_relapse$Estimate[(i - 1) * length(variables) + j] <- model_summary$coefficients[var_index, 1]
        results_sex_relapse$p_value[(i - 1) * length(variables) + j] <- model_summary$coefficients[var_index, 4]
      }
    }
  }
}

num_tests_sex_relapse <- sum(!is.na(results_sex_relapse$p_value))
results_sex_relapse$p_value_corrected <- pmin(results_sex_relapse$p_value * num_tests_sex_relapse, 1)

results_sex_relapse$Significance <- cut(results_sex_relapse$p_value_corrected, 
                                        breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
                                        labels = c("p<0.001", "p<0.01", "p<0.05", "p>0.05 (ikke signifikant)"))

ggplot(results_sex_relapse, aes(x = as.factor(Year), y = Variable, fill = Significance)) +
  geom_tile(color = "white") +
  scale_fill_manual(values = c("p>0.05 (ikke signifikant)" = "lightgray", 
                               "p<0.05" = "lightblue", 
                               "p<0.01" = "steelblue", 
                               "p<0.001" = "darkblue")) +
  labs(title = "Signifikans af Sex og Relapse over tid (Bonferroni-korrigeret)",
       x = "År", y = "Variabel", fill = "Signifikans") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "top")


```


Trends over tid
```{r}
all_filtered_imputed$YearAtFirstDiagnosis <- as.numeric(as.character(all_filtered_imputed$YearAtFirstDiagnosis))

trend_data <- all_filtered_imputed %>%
  filter(TreatmentDrugCategorized %in% c(0, 1)) %>%
  group_by(YearAtFirstDiagnosis) %>%
  summarise(proportion_HE = mean(TreatmentDrugCategorized == 1))

ggplot(trend_data, aes(x = YearAtFirstDiagnosis, y = proportion_HE)) +
  geom_point(aes(color = "Data"), alpha = 1) +
  geom_smooth(method = "loess", color = "blue", se = FALSE) +
  scale_y_continuous(limits = c(0, 1)) +
  scale_x_continuous(breaks = 2010:2024, limits = c(2010, 2024)) +
  labs(
    title = "Tendens i andel af HE behandling over tid",
    x = "År ved første diagnose",
    y = "Proportion med HE Behandling"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.8)
  )
```


Trends over tid med HE
```{r}


all_filtered_imputed$YearAtFirstDiagnosis <- as.numeric(as.character(all_filtered_imputed$YearAtFirstDiagnosis))


trend_data_both <- all_filtered_imputed %>%
  filter(TreatmentDrugCategorized %in% c(0, 1)) %>%
  group_by(YearAtFirstDiagnosis) %>%
  summarise(
    ME = mean(TreatmentDrugCategorized == 0),
    HE = mean(TreatmentDrugCategorized == 1)
  ) %>%
  pivot_longer(
    cols = c(ME, HE),
    names_to = "Group",
    values_to = "Proportion"
  )


ggplot(trend_data_both, aes(x = YearAtFirstDiagnosis, y = Proportion, color = Group)) +
  geom_point() +
  geom_smooth(method = "loess", se = FALSE) +
  scale_y_continuous(limits = c(0, 1), labels = scales::percent_format(accuracy = 1)) +
  scale_x_continuous(breaks = 2010:2024, limits = c(2010, 2024)) +
  labs(
    title = "Tendens i andel ME og HE Behandling Over Tid",
    x = "År ved første diagnose",
    y = "Proportion af patienter",
    color = "Behandlingstype"
  ) +
  theme_minimal()

```





